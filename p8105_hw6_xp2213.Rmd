---
title: "p8105 Homework 6"
output: github_document
date: "2024-12-03"
---
Name [UNI]: Xi Peng [xp2213]

```{r setup, include=FALSE}
library(tidyverse)
library(modelr)
library(broom)
library(purrr)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

set.seed(924)
```

# Question 1: 2017 Central Park weather data
```{r}
# Dataset download and processes.
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())

# Define a bootstrap sampling function.
boot_sample = function(df) {
  sample_frac(df, replace = TRUE)
}

# Bootstrap resampling.
boot_straps_result = tibble(strap_number = 1:5000) |> 
  mutate(
    strap_sample = map(strap_number, ~ boot_sample(weather_df)),
    models = map(strap_sample, ~ lm(tmax ~ tmin, data = .x)),
    results = map(models, tidy),                         
    r_squared = map_dbl(models, ~ glance(.x)$r.squared), 
    log_beta_product = map_dbl(models, ~ {       
      coefs = tidy(.x)  
      beta_0 = coefs |> filter(term == "(Intercept)") |> pull(estimate)
      beta_1 = coefs |> filter(term == "tmin") |> pull(estimate)
      log(abs(beta_0 * beta_1))
    })
  )

boot_straps_result
```
<br>
Plot the distribution of the estimates of the two quantities.
```{r}
boot_straps_plot = 
  boot_straps_result |>
  select(r_squared, log_beta_product) |> 
  pivot_longer(cols = everything(), names_to = "metric", values_to = "value") |> 
  ggplot(aes(x = value)) +
  geom_density(alpha = 0.3) +
  facet_wrap(~metric, scales = "free") +
  labs(
    title = "Bootstrap Distributions of R^2 and log(β0 * β1)",
    x = "Value",
    y = "Density"
  )

boot_straps_plot
```

Both distributions show clear, bell-shaped curves with minimal skewness, indicating that these statistics are stable and reliable across different bootstrap samples.The plot indicates a strong linear relationship between tmax and tmin in the weather data, as reflected by the consistently high r_squared values and stable log_beta_product values across 5000 bootstrap samples. The narrow distribution of r_squared values demonstrates that the model explains a substantial proportion of the variance in tmax, while the consistency of the log_beta_product values indicates minimal variability in the relationship between the coefficients. The large sample size of 5000 ensures that the distributions capture the true underlying pattern with minimal variation across resampled datasets.

<br>
95% confidence interval for the two quantities.
```{r}
CI_result = boot_straps_result |> 
  summarize(
    r_squared_CI = list(quantile(r_squared, c(0.025,0.975))),
    log_beta_product_CI = list(quantile(log_beta_product, c(0.025, 0.975)))
  ) 

knitr::kable(CI_result)
```

# Question 2: Homicide Rates Across U.S. Cities
```{r}
url = "https://raw.githubusercontent.com/washingtonpost/data-homicides/refs/heads/master/homicide-data.csv"

homi_data = read_csv(url) |> 
  janitor::clean_names() |> 
  mutate(
    city_state = str_c(city, ", ", state),
    resolved = as.numeric(disposition == "Closed by arrest"),
    victim_age = as.numeric(victim_age)
  ) |> 
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"),
    victim_race %in% c("White", "Black"), 
    !is.na(victim_age)
  )
```

In this step, the original dataset is imported, and two key variables are created: city_state, which combines the city and state names, and a binary variable, resolved, indicating whether the homicide was solved. Cities that do not report victim race, such as Dallas, TX; Phoenix, AZ; and Kansas City, MO, are excluded, along with Tulsa, AL, due to a data entry error. The analysis is further narrowed to include only cases where victim_race is recorded as either "White" or "Black" and victim_age is confirmed as a numeric value.

<br>
Analyze for Baltimore, MD
```{r}
# Filter data for Baltimore, MD
Bal_MD = homi_data |> 
  filter(city_state == "Baltimore, MD") 

# Fit a logistic regression
Bal_MD_fit = glm(
  resolved ~ victim_age + victim_race + victim_sex,
  data = Bal_MD, family = binomial()
) |> 
  tidy()

knitr::kable(Bal_MD_fit, digits = 3)

ORmale_Bal_MD = Bal_MD_fit |> 
  mutate(
    OR = exp(estimate),
    lower_CI = exp(estimate - 1.96 * std.error),
    upper_CI = exp(estimate + 1.96 * std.error)
  ) |> 
  filter(term == "victim_sexMale") |> 
  select(term, OR, lower_CI, upper_CI)

knitr::kable(ORmale_Bal_MD, digits = 3)
```

```{r}
# Fit a logistic regression for each city
all_city_results <- homi_data |> 
  group_by(city_state) |> 
  nest() |> 
  mutate(
    model = map(data, ~ glm(resolved ~ victim_age + victim_race + victim_sex, 
                            data = .x, family = binomial())),
    tidy_results = map(model, ~ tidy(.x) |> 
                         filter(term == "victim_sexMale") |> 
                         mutate(
                           OR = exp(estimate),
                           lower_CI = exp(estimate - 1.96 * std.error),
                           upper_CI = exp(estimate + 1.96 * std.error)
                         ))
  ) |> 
  unnest(tidy_results) |> 
  select(city_state, OR, lower_CI, upper_CI)

knitr::kable(all_city_results, digits = 3)
```

<br>
Plot of the estimated ORs and CIs for all city.
```{r}
all_city_results_plot = 
  all_city_results |> 
  ggplot(aes(x = reorder(city_state, OR), y = OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower_CI, ymax = upper_CI), width = 0.2) +
  coord_flip() +
  labs(
    title = "Odds Ratios for Solving Homicides (Male vs Female Victims)",
    x = "City",
    y = "Odds Ratio"
  )

all_city_results_plot
```

The plot reveals that in most cities, the ORs are below 1, suggesting that cases involving female victims are more likely to be resolved compared to those involving male victims. However, the CIs for the majority of cities include the null value of 1, indicating that these differences in case resolution rates between male and female victims are not statistically significant. Cities such as Stockton, CA, Fresno, CA, Richmond, VA, Tampa, FL, and San Bernardino, CA exhibit notably wider confidence intervals, which may reflect greater variability or smaller sample sizes relative to other cities. Albuquerque, NM stands out with a substantially higher OR and an exceptionally wide CI, making it a potential outlier that warrants further investigation to understand the underlying factors contributing to this result.

# Question 3: Child’s birthweight
```{r}
# Dataset import and clean
child_birthweight =
    read_csv("data/birthweight.csv", na = c("NA", "", ".", " ")) |> 
  janitor::clean_names() |> 
  drop_na() |> 
  mutate(
    babysex = factor(babysex, levels = c(1, 2), labels = c("Male", "Female")),
    frace = factor(frace, levels = c(1, 2, 3, 4, 8, 9), labels = c("White", "Black", "Asian", "Puerto Rican", "Other", "Unknown")),
    mrace = factor(mrace, levels = c(1, 2, 3, 4, 8), labels = c("White", "Black", "Asian", "Puerto Rican", "Other")),
    malform = factor(malform, levels = c(0, 1), labels = c("Absent", "Present"))
  )
```

During this step, the original dataset was imported, and necessary variables (babysex, frace, mrace, and malform) were converted from numeric to factors to ensure they are treated as categorical variables in the analysis. Missing values were checked.



